# QFPv3 éŸ³é¢‘ç¼–è§£ç å™¨

<div align="center">

**Quantum Frequency Processor v3**  
*ä¸€ä¸ªåŸºäº MDCT çš„å®éªŒæ€§é«˜æ•ˆéŸ³é¢‘å‹ç¼©ç¼–è§£ç å™¨*

[![Python](https://img.shields.io/badge/Python-3.8+-blue.svg)](https://www.python.org/)
[![License](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)

</div>

---

## ğŸ“– ç®€ä»‹

QFPv3 (Quantum Frequency Processor v3) æ˜¯ä¸€ä¸ªå®éªŒæ€§çš„æœ‰æŸéŸ³é¢‘ç¼–è§£ç å™¨ï¼Œé€šè¿‡æ—¶é¢‘è½¬æ¢ã€æ„ŸçŸ¥å»ºæ¨¡ã€å¤šçº§æµ®ç‚¹é‡åŒ–ä»¥åŠæ™ºèƒ½å‹ç¼©æŠ€æœ¯å®ç°é«˜æ•ˆç‡çš„éŸ³é¢‘å‹ç¼©ã€‚

### âœ¨ æ ¸å¿ƒç‰¹æ€§

- ğŸµ **MDCT æ—¶é¢‘å˜æ¢** - ä½¿ç”¨ä¿®æ”¹ç¦»æ•£ä½™å¼¦å˜æ¢è·å¾—ä¼˜ç§€çš„é¢‘åŸŸèƒ½é‡é›†ä¸­ç‰¹æ€§
- ğŸšï¸ **M/S ç«‹ä½“å£°ç¼–ç ** - æ¶ˆé™¤å·¦å³å£°é“å†—ä½™ï¼Œæå‡å‹ç¼©æ•ˆç‡
- ğŸ¯ **é¢‘ç‡è‡ªé€‚åº”é‡åŒ–** - ä½é¢‘é«˜ç²¾åº¦ (8-bit)ï¼Œé«˜é¢‘ä½ç²¾åº¦ (2-bit)ï¼Œç¬¦åˆäººè€³æ„ŸçŸ¥ç‰¹æ€§
- âœ‚ï¸ **å…¨å±€é˜ˆå€¼å‰ªæ** - æ™ºèƒ½ç§»é™¤ä½èƒ½é‡ç³»æ•°ï¼Œå¤§å¹…é™ä½æ•°æ®é‡
- ğŸ“¦ **å¤šæ¯”ç‰¹æ¡¶åˆ†å±‚å‹ç¼©** - 8/6/4/2-bit æµ®ç‚¹é‡åŒ–ï¼Œç²¾ç»†æ§åˆ¶ç²¾åº¦ä¸å¤§å°å¹³è¡¡
- ğŸ”Š **å™ªå£°å¡«å……æŠ€æœ¯** - è§£ç ç«¯æ¢å¤è¢«å‰ªæé¢‘æ®µçš„èƒ½é‡ï¼Œæå‡ä¸»è§‚å¬æ„Ÿ
- ğŸ—œï¸ **å¤šé‡å‹ç¼©** - ä½ç½®ç¼–ç  + æ¯”ç‰¹æ‰“åŒ… + Zlib ç»ˆæå‹ç¼©

---

## ğŸ—ï¸ ç®—æ³•æ¶æ„

### ç¼–ç æµç¨‹

```mermaid
graph LR
    A[éŸ³é¢‘æ–‡ä»¶] --> B[M/S åˆ†ç¦»]
    B --> C[MDCT å˜æ¢]
    C --> D[é¢‘æ®µåˆ†å‰²]
    D --> E[æƒé‡è®¡ç®—]
    E --> F[å…¨å±€å‰ªæ]
    F --> G[é‡åŒ–ç¼–ç ]
    G --> H[æ¯”ç‰¹æ¡¶æ‰“åŒ…]
    H --> I[å¸§å°è£…+CRC]
    I --> J[Zlibå‹ç¼©]
    J --> K[QFPæ–‡ä»¶]
```

### è§£ç æµç¨‹

```mermaid
graph LR
    A[QFPæ–‡ä»¶] --> B[Zlibè§£å‹]
    B --> C[å¸§è§£æ+CRC]
    C --> D[æ¯”ç‰¹æ¡¶è§£åŒ…]
    D --> E[åé‡åŒ–]
    E --> F[å™ªå£°å¡«å……]
    F --> G[iMDCTé€†å˜æ¢]
    G --> H[M/Såˆå¹¶]
    H --> I[é‡å ç›¸åŠ ]
    I --> J[éŸ³é¢‘è¾“å‡º]
```

---

## ğŸ“¦ å®‰è£…

### ä¾èµ–é¡¹

```bash
# å¿…éœ€ä¾èµ–
numpy>=1.20.0
soundfile>=0.11.0
scipy>=1.7.0
tqdm>=4.60.0
```

### å®‰è£…æ–¹æ³•

```bash
# å…‹éš†ä»“åº“
git clone https://github.com/haveyouwantto/QFPv3.git
cd QFPv3

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### åŸºæœ¬ç”¨æ³•

```python
from main import QFP3Codec

# åˆ›å»ºç¼–è§£ç å™¨å®ä¾‹
encoder = QFP3Codec()

# å‹ç¼©éŸ³é¢‘
encoder.compress(
    audio_file="input.wav",   # è¾“å…¥éŸ³é¢‘æ–‡ä»¶
    out_file="output.qfp",    # è¾“å‡º QFP æ–‡ä»¶
    qp=32                     # è´¨é‡å‚æ•° (0-63, è¶Šå¤§è´¨é‡è¶Šä½)
)

# è§£å‹éŸ³é¢‘
encoder.decompress(
    in_file="output.qfp",     # è¾“å…¥ QFP æ–‡ä»¶
    out_file="result.wav"     # è¾“å‡ºéŸ³é¢‘æ–‡ä»¶
)
```

### è´¨é‡å‚æ•° (QP) è¯´æ˜

| QP å€¼ | è´¨é‡ç­‰çº§ | å‹ç¼©ç‡ | é€‚ç”¨åœºæ™¯ |
|-------|---------|--------|---------|
| 0-15  | é«˜è´¨é‡   | ä½     | éŸ³ä¹å½’æ¡£ã€æ— æŸæ›¿ä»£ |
| 16-31 | ä¸­é«˜è´¨é‡ | ä¸­     | æ—¥å¸¸éŸ³ä¹æ’­æ”¾ |
| 32-47 | ä¸­ç­‰è´¨é‡ | é«˜     | æµåª’ä½“ã€æ’­å®¢ (é»˜è®¤) |
| 48-63 | ä½è´¨é‡   | æé«˜   | è¯­éŸ³ã€æé™å‹ç¼© |

---

## ğŸ“‚ é¡¹ç›®ç»“æ„

```
QFPv3/
â”œâ”€â”€ main.py              # ä¸»ç¼–è§£ç å™¨å®ç°
â”œâ”€â”€ quant_plan.py        # é‡åŒ–æ–¹æ¡ˆ (æµ®ç‚¹/æ•´æ•°é‡åŒ–å™¨)
â”œâ”€â”€ num_encoder.py       # æ•°å€¼ç¼–ç å™¨ (ä½ç½®ç¼–ç ã€å‰ç¼€ç¼–ç )
â”œâ”€â”€ dsp.py               # DSP å‡½æ•° (MDCT/iMDCT/çª—å‡½æ•°)
â”œâ”€â”€ frame.py             # å¸§å°è£…ä¸ CRC æ ¡éªŒ
â”œâ”€â”€ util.py              # å·¥å…·å‡½æ•°
â””â”€â”€ README.md            # æœ¬æ–‡ä»¶
```

### æ ¸å¿ƒæ¨¡å—è¯´æ˜

#### 1. `main.py` - ä¸»ç¼–è§£ç å™¨

åŒ…å« `QFP3Codec` ç±»ï¼Œå®ç°å®Œæ•´çš„ç¼–è§£ç æµç¨‹ï¼š

- **å‹ç¼© (`compress`)**: 
  - éŸ³é¢‘é¢„å¤„ç†ä¸çª—å£å‚æ•°è®¡ç®—
  - é¢‘ç‡è‡ªé€‚åº” Band Plan æ„å»º
  - åŒé€šé“ (L+R/L-R) é‡åŒ–æ–¹æ¡ˆç”Ÿæˆ
  - é€å¸§ MDCT å˜æ¢ã€å…¨å±€å‰ªæã€é‡åŒ–ç¼–ç 
  - æ¯”ç‰¹æ¡¶æ‰“åŒ…ä¸å¸§å°è£…
  - Zlib ç»ˆæå‹ç¼©

- **è§£å‹ (`decompress`)**:
  - æ–‡ä»¶å¤´ä¸å…ƒæ•°æ®è§£æ
  - Zlib è§£å‹ä¸å¸§è§£å°è£…
  - æ¯”ç‰¹æ¡¶æ•°æ®æ¢å¤ä¸åé‡åŒ–
  - å™ªå£°å¡«å…… (PNS)
  - iMDCT é€†å˜æ¢ä¸é‡å ç›¸åŠ  (OLA)

#### 2. `quant_plan.py` - é‡åŒ–å™¨

å®ç°å¤šç§é‡åŒ–æ–¹æ¡ˆï¼š

- **FloatQuantizer**: è‡ªå®šä¹‰æµ®ç‚¹é‡åŒ–å™¨
  - æ”¯æŒ 4/6/8-bit æµ®ç‚¹ç¼–ç 
  - å¯é…ç½®æŒ‡æ•°ä½ã€å°¾æ•°ä½
  - æ”¯æŒéè§„æ ¼åŒ–æ•° (Denormal)
  
- **Int2BitSpecialQuantizer**: 2-bit ç‰¹æ®Šæ•´æ•°é‡åŒ–å™¨
  - ç”¨äºæä½æ¯”ç‰¹ç‡çš„é«˜é¢‘æ®µ

- **float_pack/float_unpack**: æ¯”ç‰¹çº§æ‰“åŒ…/è§£åŒ…å‡½æ•°
  - æ”¯æŒ 2/4/6/8-bit ä»»æ„ä½å®½

#### 3. `num_encoder.py` - æ•°å€¼ç¼–ç 

- **ä½ç½®ç¼–ç  (`pos_encode/pos_decode`)**: 
  - è®°å½•éé›¶ç³»æ•°ä½ç½®ï¼Œè·³è¿‡é•¿é›¶åºåˆ—
  - è‡ªåŠ¨çœç•¥æœ«å°¾é›¶
  
- **å‰ç¼€ç¼–ç  (`prefix_encode/prefix_decode`)**:
  - å˜é•¿æ•´æ•°ç¼–ç  (1-4 å­—èŠ‚)
  - ç±»ä¼¼ UTF-8 çš„å‰ç¼€æœºåˆ¶
  
- **ç¼©æ”¾å› å­ç¼–ç  (`encode_scale/decode_scale`)**:
  - å¯¹æ•°åŸŸ 8-bit é‡åŒ–
  - æ”¯æŒ 2^-40 åˆ° 2^0 çš„åŠ¨æ€èŒƒå›´

#### 4. `dsp.py` - æ•°å­—ä¿¡å·å¤„ç†

- `mdct()` / `imdct()`: MDCT æ­£é€†å˜æ¢
- `create_mdct_window()`: Vorbis çª—å‡½æ•°ç”Ÿæˆ

#### 5. `frame.py` - å¸§ç®¡ç†

- `encapsulate_frame()` / `decapsulate_frame()`: å¸§å°è£…/è§£å°è£…
- `crc16()`: CRC-16 æ ¡éªŒå’Œè®¡ç®—

---

## ğŸ”¬ æŠ€æœ¯ç»†èŠ‚

### 1. M/S ç«‹ä½“å£°ç¼–ç 

å°†ä¼ ç»Ÿçš„ L/R (å·¦/å³) ä¿¡å·è½¬æ¢ä¸º M/S (ä¸­/ä¾§) ä¿¡å·ï¼š

$$
\begin{aligned}
M &= (L + R) / 2 \\
S &= (L - R) / 2
\end{aligned}
$$

**ä¼˜åŠ¿**:
- Mid (M) åŒ…å«å•å£°é“å†…å®¹ (ä¸»è¦èƒ½é‡)
- Side (S) åŒ…å«ç«‹ä½“å£°å®½åº¦ (é€šå¸¸èƒ½é‡è¾ƒå°)
- å¯å¯¹ S é€šé“ä½¿ç”¨æ›´ä½æ¯”ç‰¹ç‡ï¼Œæå‡æ•´ä½“å‹ç¼©æ•ˆç‡

### 2. é¢‘ç‡è‡ªé€‚åº”é‡åŒ–ç­–ç•¥

| é¢‘ç‡èŒƒå›´ | é‡åŒ–çº§åˆ« | æ¯”ç‰¹æ•° | ä¿ç•™ç‡ | åŸå›  |
|---------|---------|-------|-------|------|
| 0-4 kHz | 0 | 8-bit | 100% | äººè€³æœ€æ•æ„Ÿï¼ŒåŒ…å«åŸºéŸ³ |
| 4-6 kHz | 3 | 6-bit | 70% | ä¸­é¢‘é‡è¦è°æ³¢ |
| 6-8 kHz | 5 | 6-bit | 50% | ä¸­é«˜é¢‘å¹³è¡¡ |
| 8-12 kHz | 6-7 | 4-bit | 25% | é«˜é¢‘å¼€å§‹è¡°å‡ |
| 12-16 kHz | 8-9 | 4/2-bit | 16% | æé«˜é¢‘ï¼Œä¸»è¦ç©ºæ°”æ„Ÿ |
| >20 kHz | 15 | è·³è¿‡ | 0% | è¶…å£°æ³¢ï¼Œäººè€³æ— æ³•æ„ŸçŸ¥ |

### 3. å…¨å±€é˜ˆå€¼å‰ªæç®—æ³•

**æƒé‡æ¨¡å‹** (ä¸‰å› ç´ ):

$$
W_{band} = f_w \times p_w \times qp_{slope}
$$

- **f_w** (é¢‘ç‡æƒé‡): ç”± `band_plan` çš„ `kr_base` å†³å®šï¼Œä½é¢‘é«˜æƒé‡
- **p_w** (ç²¾åº¦æƒé‡): å¹³è¡¡ä¸åŒé‡åŒ–çº§åˆ«ï¼Œé˜²æ­¢ä½æ¯”ç‰¹é¢‘æ®µè¢«è¿‡åº¦å‰ªæ
- **qp_slope** (QP æ–œç‡): é«˜ QP æ—¶å‘ä½é¢‘å€¾æ–œï¼Œä¿æŠ¤åŸºéŸ³

**é˜ˆå€¼è®¡ç®—**:

1. è®¡ç®—åŠ æƒç³»æ•°: `weighted_coeffs = abs(mdct_coeff) * weights`
2. ç¡®å®šä¿ç•™ç‡: `keep_ratio = f(QP, ms_ratio)`
3. ç™¾åˆ†ä½é˜ˆå€¼: `threshold = percentile(weighted_coeffs, (1-keep_ratio)*100)`
4. å‰ªæ: ä¿ç•™ `weighted_coeffs >= threshold` çš„ç³»æ•°

### 4. å™ªå£°å¡«å…… (PNS)

**ç¼–ç ç«¯**:
- è®°å½•æ¯ä¸ªé¢‘æ®µçš„é‡åŒ–æŸå¤± `amp_loss`

**è§£ç ç«¯**:
1. å¯¹ `amp_loss` è¿›è¡Œçº¿æ€§æ’å€¼ï¼Œç”Ÿæˆå…¨é¢‘æ®µå™ªå£°åŒ…ç»œ
2. ç”Ÿæˆé«˜æ–¯ç™½å™ªå£°
3. åœ¨ MDCT ç³»æ•°ä¸º 0 çš„ä½ç½®æ³¨å…¥å™ªå£°ï¼Œå¼ºåº¦ç”±åŒ…ç»œæ§åˆ¶

**æ•ˆæœ**:
- æ¢å¤è¢«å‰ªæé¢‘æ®µçš„èƒ½é‡
- å¢å¼ºä¸»è§‚"ç©ºæ°”æ„Ÿ"
- é¿å…é«˜é¢‘"æ–­è£‚"æ„Ÿ

---

## ğŸ“Š æ€§èƒ½è¡¨ç°

### å‹ç¼©æ¯”æµ‹è¯• (åŸºäº 44.1kHz ç«‹ä½“å£°éŸ³é¢‘)

| åŸæ ¼å¼ | åŸå¤§å° | QP | QFP å¤§å° | å‹ç¼©ç‡ | éŸ³è´¨è¯„ä»· |
|-------|-------|---|---------|---------|---------| 
| WAV   | 40 MB | 16 | ~7.7 MB | 5.19x | æ¥è¿‘é€æ˜ |
| WAV   | 40 MB | 32 | ~6.1 MB | 6.55x | è‰¯å¥½ (é»˜è®¤) |
| WAV   | 40 MB | 48 | ~1.6 MB | 25.0x | å¯æ¥å— |

> **æ³¨**: å®é™…å‹ç¼©ç‡å–å†³äºéŸ³é¢‘å†…å®¹å¤æ‚åº¦ã€é¢‘è°±åˆ†å¸ƒç­‰å› ç´ 

---

## ğŸ›ï¸ æ–‡ä»¶æ ¼å¼è§„èŒƒ

### QFP æ–‡ä»¶ç»“æ„

```
[Magic: 4B]           "QFPA"
[Version: 1B]         ç‰ˆæœ¬å· (å½“å‰ä¸º 3)
[Sample Rate: 4B]     é‡‡æ ·ç‡ (Hz)
[Window Size: 4B]     MDCT çª—å£å¤§å°
[Num Windows: 4B]     æ€»çª—å£æ•°
[Band Size: 4B]       é¢‘æ®µå¤§å° (ç³»æ•°æ•°/é¢‘æ®µ)

[Metadata Start: 1B]  0x55
  [Type: 1B][Len: å˜é•¿][Data: Lenå­—èŠ‚]
  ...
[Metadata End: 1B]    0xAA

[L+R Quant Plan]      4-bit æ‰“åŒ…é‡åŒ–æ–¹æ¡ˆ
[L-R Quant Plan]      4-bit æ‰“åŒ…é‡åŒ–æ–¹æ¡ˆ

[Zlib Compressed Frames]
  â”œâ”€ Frame 1: [CRC:2B][Bitmap][Metadata][Buckets]
  â”œâ”€ Frame 2: ...
  â””â”€ Frame N: ...
```

### å…ƒæ•°æ®ç±»å‹

| Type | åç§° | è¯´æ˜ |
|------|------|------|
| 0x01 | TITLE | æ›²ç›®æ ‡é¢˜ |
| 0x02 | ARTIST | è‰ºæœ¯å®¶ |
| 0x03 | ALBUM_ARTIST | ä¸“è¾‘è‰ºæœ¯å®¶ |
| 0x04 | ALBUM | ä¸“è¾‘åç§° |
| 0x10 | FRONT_COVER | å°é¢å›¾ç‰‡ (äºŒè¿›åˆ¶) |
| 0x11 | LYRICS | æ­Œè¯ (UTF-8) |
| 0x20 | ENCODER_VER | ç¼–ç å™¨ç‰ˆæœ¬ |
| 0xFF | COMMENT | å¤‡æ³¨ |

---

## ğŸ› ï¸ å¼€å‘ä¸è°ƒè¯•

### è¿è¡Œæµ‹è¯•

```bash
# ç›´æ¥è¿è¡Œä¸»ç¨‹åº
python main.py

# è¿è¡Œé‡åŒ–å™¨æµ‹è¯•
python quant_plan.py

# è¿è¡Œç¼–ç å™¨æµ‹è¯•
python num_encoder.py
```

### è°ƒè¯•è¾“å‡º

è§£å‹æ—¶ä¼šç”Ÿæˆ `out.dump` æ–‡ä»¶ï¼ŒåŒ…å« Zlib è§£å‹åçš„åŸå§‹å¸§æ•°æ®ï¼Œå¯ç”¨äºè°ƒè¯•ã€‚

## ğŸ“š ç›¸å…³èµ„æº

### å‚è€ƒèµ„æ–™

- [MDCT - Wikipedia](https://en.wikipedia.org/wiki/Modified_discrete_cosine_transform)
- [Vorbis I Specification](https://xiph.org/vorbis/doc/Vorbis_I_spec.html)
- [AAC ç¼–ç åŸç†](https://en.wikipedia.org/wiki/Advanced_Audio_Coding)

---

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿è´¡çŒ®ä»£ç ã€æŠ¥å‘Šé—®é¢˜æˆ–æå‡ºæ”¹è¿›å»ºè®®ï¼

### è´¡çŒ®æµç¨‹

1. Fork æœ¬ä»“åº“
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/amazing-feature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add amazing feature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/amazing-feature`)
5. æäº¤ Pull Request

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å®éªŒæ€§é¡¹ç›®**: QFPv3 ç›®å‰ä»æ˜¯å®éªŒæ€§è´¨ï¼Œä¸å»ºè®®ç”¨äºç”Ÿäº§ç¯å¢ƒ
2. **æœ‰æŸå‹ç¼©**: è¿™æ˜¯æœ‰æŸç¼–è§£ç å™¨ï¼Œè§£å‹åçš„éŸ³é¢‘ä¸åŸå§‹éŸ³é¢‘å­˜åœ¨å·®å¼‚
3. **å…¼å®¹æ€§**: ä»…æ”¯æŒç«‹ä½“å£°éŸ³é¢‘ï¼Œå•å£°é“ä¼šè‡ªåŠ¨è½¬æ¢ä¸ºåŒå£°é“
4. **éŸ³é¢‘é•¿åº¦**: å½“å‰ç‰ˆæœ¬é™åˆ¶å¤„ç†å‰ 15 ç§’ (å¯åœ¨ä»£ç ä¸­è°ƒæ•´)

---

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶

---

## ğŸ‘¨â€ğŸ’» ä½œè€…

- **Your Name** - *Initial work*

---

## ğŸ™ è‡´è°¢

- æ„Ÿè°¢ NumPyã€SciPyã€SoundFile ç­‰å¼€æºé¡¹ç›®
- å‚è€ƒäº† Vorbisã€AAC ç­‰æˆç†Ÿç¼–è§£ç å™¨çš„è®¾è®¡æ€æƒ³
- æ„Ÿè°¢æ‰€æœ‰ä¸ºéŸ³é¢‘ç¼–è§£ç æŠ€æœ¯åšå‡ºè´¡çŒ®çš„ç ”ç©¶è€…

---

<div align="center">

**å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸€ä¸ª â­ Starï¼**

Made with â¤ï¸ and ğŸµ

</div>
